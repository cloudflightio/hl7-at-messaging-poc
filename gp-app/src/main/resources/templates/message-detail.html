<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Message Detail - GP Practice</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .document-content {
            white-space: pre-wrap;
            font-family: monospace;
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 0.25rem;
        }
        .fhir-json {
            max-height: 400px;
            overflow-y: auto;
            font-size: 0.75rem;
        }
        .pdf-viewer {
            width: 100%;
            height: 600px;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
        }
        .pdf-download-section {
            background-color: #f8f9fa;
            border-radius: 0.25rem;
            padding: 1.5rem;
            text-align: center;
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-success">
        <div class="container">
            <a class="navbar-brand" href="/">
                <strong>GP</strong> - Dr. Huber's Practice
            </a>
        </div>
    </nav>

    <div class="container mt-4">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Inbox</a></li>
                <li class="breadcrumb-item active">Message Detail</li>
            </ol>
        </nav>

        <div class="row">
            <!-- Message Content -->
            <div class="col-lg-8">
                <div class="card mb-3">
                    <div class="card-header bg-white">
                        <h5 class="mb-1">
                            <span th:if="${message.document}" th:text="${message.subject} ?: (${message.documentTitle} ?: 'Document')">Subject</span>
                            <span th:if="${message.communication}">Text Message</span>
                        </h5>
                        <small class="text-muted">
                            From: <span th:text="${message.sourceName}">Source</span> |
                            Received: <span th:text="${#dates.format(message.receivedAt, 'dd.MM.yyyy HH:mm:ss')}">Date</span>
                            <span th:if="${message.response}" class="badge bg-success ms-2">Response to Request</span>
                        </small>
                    </div>
                    <div class="card-body">
                        <!-- Response indicator -->
                        <div th:if="${message.response}" class="alert alert-success mb-3">
                            <small>This message is a response to your previous consult request.</small>
                        </div>

                        <!-- Patient Information -->
                        <div th:if="${message.patientName}" class="alert alert-info">
                            <h6 class="alert-heading mb-1">Patient Information</h6>
                            <p class="mb-0">
                                <strong th:text="${message.patientName}">Patient Name</strong>
                                <span th:if="${message.patientBirthDate}" class="ms-3">
                                    | Born: <span th:text="${message.patientBirthDate}"></span>
                                </span>
                            </p>
                        </div>

                        <!-- Communication/Text Message Content -->
                        <div th:if="${message.communication && message.communicationText != null}">
                            <h6>Message Content</h6>
                            <div class="document-content" th:text="${message.communicationText}">
                                Message content here...
                            </div>
                        </div>

                        <!-- PDF Document -->
                        <div th:if="${message.document && message.documentContentType == 'application/pdf'}">
                            <h6>PDF Document</h6>
                            <div class="pdf-download-section mb-3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="bi bi-file-earmark-pdf text-danger mb-3" viewBox="0 0 16 16">
                                    <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/>
                                    <path d="M4.603 14.087a.81.81 0 0 1-.438-.42c-.195-.388-.13-.776.08-1.102.198-.307.526-.568.897-.787a7.68 7.68 0 0 1 1.482-.645 19.697 19.697 0 0 0 1.062-2.227 7.269 7.269 0 0 1-.43-1.295c-.086-.4-.119-.796-.046-1.136.075-.354.274-.672.65-.823.192-.077.4-.12.602-.077a.7.7 0 0 1 .477.365c.088.164.12.356.127.538.007.188-.012.396-.047.614-.084.51-.27 1.134-.52 1.794a10.954 10.954 0 0 0 .98 1.686 5.753 5.753 0 0 1 1.334.05c.364.066.734.195.96.465.12.144.193.32.2.518.007.192-.047.382-.138.563a1.04 1.04 0 0 1-.354.416.856.856 0 0 1-.51.138c-.331-.014-.654-.196-.933-.417a5.712 5.712 0 0 1-.911-.95 11.651 11.651 0 0 0-1.997.406 11.307 11.307 0 0 1-1.02 1.51c-.292.35-.609.656-.927.787a.793.793 0 0 1-.58.029z"/>
                                </svg>
                                <p class="mb-2 text-muted" th:text="${message.documentFilename} ?: 'PDF Document'">document.pdf</p>
                                <a th:href="@{/messages/{id}/download(id=${message.id})}" class="btn btn-primary">
                                    Download PDF
                                </a>
                            </div>
                        </div>

                        <!-- Text Document Content -->
                        <div th:if="${message.document && message.documentContent != null}">
                            <h6>Document Content</h6>
                            <div class="document-content" th:text="${message.documentContent}">
                                Document content here...
                            </div>
                        </div>

                        <div th:if="${message.document && message.documentContentType != 'application/pdf' && message.documentContent == null}" class="text-muted">
                            <p>No document content available.</p>
                        </div>
                    </div>
                </div>

                <!-- FHIR Bundle JSON -->
                <div class="card" th:if="${bundleJson}">
                    <div class="card-header bg-white">
                        <h6 class="mb-0">FHIR Bundle (JSON)</h6>
                        <small class="text-muted">Full message bundle as stored in FHIR server</small>
                    </div>
                    <div class="card-body p-0">
                        <pre class="fhir-json m-0 p-3"><code th:text="${bundleJson}"></code></pre>
                    </div>
                </div>
            </div>

            <!-- Message Metadata -->
            <div class="col-lg-4">
                <div class="card mb-3">
                    <div class="card-header bg-white">
                        <h6 class="mb-0">Message Details</h6>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm table-borderless mb-0">
                            <tr>
                                <td class="text-muted">Message ID</td>
                                <td><code th:text="${message.id}">id</code></td>
                            </tr>
                            <tr>
                                <td class="text-muted">Event Type</td>
                                <td>
                                    <span class="badge"
                                          th:classappend="${message.eventCode == 'document'} ? 'bg-primary' : 'bg-info'"
                                          th:text="${message.eventCode}">event</span>
                                </td>
                            </tr>
                            <tr th:if="${message.response}">
                                <td class="text-muted">Response To</td>
                                <td>
                                    <a th:href="@{/sent-requests/by-bundle/{bundleId}(bundleId=${message.responseToRequestId})}"
                                       class="text-decoration-none">
                                        <code th:text="${message.responseToRequestId}">request-id</code>
                                    </a>
                                </td>
                            </tr>
                            <tr>
                                <td class="text-muted">Source</td>
                                <td th:text="${message.sourceName}">Source</td>
                            </tr>
                            <tr th:if="${message.sourceSoftware}">
                                <td class="text-muted">Software</td>
                                <td>
                                    <span th:text="${message.sourceSoftware}">Software</span>
                                    <span th:if="${message.sourceVersion}" class="text-muted">
                                        v<span th:text="${message.sourceVersion}"></span>
                                    </span>
                                </td>
                            </tr>
                            <tr th:if="${message.sourceContact}">
                                <td class="text-muted">Contact</td>
                                <td th:text="${message.sourceContact}">contact@example.com</td>
                            </tr>
                            <tr>
                                <td class="text-muted">Received</td>
                                <td th:text="${#dates.format(message.receivedAt, 'dd.MM.yyyy HH:mm:ss')}">Date</td>
                            </tr>
                            <tr th:if="${message.fhirBundleId}">
                                <td class="text-muted">FHIR Bundle ID</td>
                                <td><code th:text="${message.fhirBundleId}">id</code></td>
                            </tr>
                        </table>
                    </div>
                </div>

                <div class="card mb-3" th:if="${message.senderName != null || message.senderOrganization != null}">
                    <div class="card-header bg-white">
                        <h6 class="mb-0">Sender Information</h6>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm table-borderless mb-0">
                            <tr th:if="${message.senderName}">
                                <td class="text-muted">Sender</td>
                                <td th:text="${message.senderName}">Dr. Name</td>
                            </tr>
                            <tr th:if="${message.senderOrganization}">
                                <td class="text-muted">Organization</td>
                                <td th:text="${message.senderOrganization}">Organization Name</td>
                            </tr>
                            <tr th:if="${message.senderOrganizationType}">
                                <td class="text-muted">Org. Type</td>
                                <td th:text="${message.senderOrganizationType}">Hospital</td>
                            </tr>
                        </table>
                    </div>
                </div>

                <div class="card mb-3" th:if="${message.documentTitle}">
                    <div class="card-header bg-white">
                        <h6 class="mb-0">Document Information</h6>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm table-borderless mb-0">
                            <tr>
                                <td class="text-muted">Title</td>
                                <td th:text="${message.documentTitle}">Title</td>
                            </tr>
                            <tr>
                                <td class="text-muted">Type</td>
                                <td th:text="${message.documentType}">Type</td>
                            </tr>
                            <tr th:if="${message.documentCategory}">
                                <td class="text-muted">Category</td>
                                <td th:text="${message.documentCategory}">Category</td>
                            </tr>
                            <tr th:if="${message.documentAuthorName}">
                                <td class="text-muted">Author</td>
                                <td th:text="${message.documentAuthorName}">Author Name</td>
                            </tr>
                            <tr th:if="${message.documentDate}">
                                <td class="text-muted">Date</td>
                                <td th:text="${#dates.format(message.documentDate, 'dd.MM.yyyy HH:mm')}">Date</td>
                            </tr>
                            <tr th:if="${message.documentContentType}">
                                <td class="text-muted">Format</td>
                                <td>
                                    <span th:if="${message.documentContentType == 'application/pdf'}" class="badge bg-danger">PDF</span>
                                    <span th:unless="${message.documentContentType == 'application/pdf'}" th:text="${message.documentContentType}">Format</span>
                                </td>
                            </tr>
                            <tr th:if="${message.documentFilename}">
                                <td class="text-muted">Filename</td>
                                <td th:text="${message.documentFilename}">filename.pdf</td>
                            </tr>
                        </table>
                    </div>
                </div>

                <div class="d-grid">
                    <a href="/" class="btn btn-outline-secondary">Back to Inbox</a>
                </div>
            </div>
        </div>
    </div>

    <footer class="mt-5 py-3 bg-white border-top">
        <div class="container text-center text-muted small">
            AT Messaging Implementation Guide - Proof of Concept
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
